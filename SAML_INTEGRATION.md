# SAML Authentication Integration with passport-ubcshib

This document explains how TLEF-CREATE integrates with UBC's Shibboleth Identity Provider using the `passport-ubcshib` library.

## Overview

TLEF-CREATE uses `passport-ubcshib` for SAML 2.0 authentication against UBC's Shibboleth Identity Provider. This allows users to authenticate using their UBC CWL credentials.

## Architecture

```
User Browser → TLEF-CREATE App → UBC Shibboleth IdP
                     ↓
              MongoDB (User Storage)
```

### Key Components

1. **passport-ubcshib** - Custom Passport.js strategy for UBC Shibboleth
2. **Express session** - Maintains user sessions
3. **MongoDB** - Stores user profiles and stats
4. **SAML 2.0** - Authentication protocol

## Configuration

### Environment Variables

The application supports three environments:

#### 1. LOCAL (Development with docker-simple-saml)
```env
SAML_ENVIRONMENT=LOCAL
SAML_ENTRY_POINT=http://localhost:8080/simplesaml/saml2/idp/SSOService.php
SAML_LOGOUT_URL=http://localhost:8080/simplesaml/saml2/idp/SingleLogoutService.php
```

#### 2. STAGING (UBC Staging IdP)
```env
SAML_ENVIRONMENT=STAGING
# Automatically uses: https://authentication.stg.id.ubc.ca
SAML_ISSUER=https://create.staging.apps.ltic.ubc.ca
SAML_CALLBACK_URL=https://create.staging.apps.ltic.ubc.ca/api/create/auth/saml/callback
SAML_PRIVATE_KEY_PATH=/etc/create-staging/saml/sp-key.pem
SAML_CERT_PATH=/etc/create-staging/saml/idp-cert.pem
```

#### 3. PRODUCTION (UBC Production IdP)
```env
SAML_ENVIRONMENT=PRODUCTION
# Automatically uses: https://authentication.ubc.ca
SAML_ISSUER=https://create.apps.ltic.ubc.ca
SAML_CALLBACK_URL=https://create.apps.ltic.ubc.ca/api/create/auth/saml/callback
SAML_PRIVATE_KEY_PATH=/etc/create-production/saml/sp-key.pem
SAML_CERT_PATH=/etc/create-production/saml/idp-cert.pem
```

### Required Files for Staging/Production

1. **Service Provider Private Key** (`sp-key.pem`)
   - Used to sign SAML requests
   - Must be kept secure
   - Generated by your team

2. **Identity Provider Certificate** (`idp-cert.pem`)
   - Used to verify SAML responses from UBC IdP
   - Obtained from UBC IAM team or IdP metadata

## Authentication Flow

### Login Flow

1. User accesses protected route
2. Middleware redirects to `/api/create/auth/saml/login`
3. passport-ubcshib generates SAML AuthnRequest
4. User redirected to UBC Shibboleth IdP
5. User authenticates with CWL credentials
6. IdP sends SAML Response to callback URL
7. passport-ubcshib validates response
8. User profile created/updated in MongoDB
9. User logged into session
10. User redirected to application

### Logout Flow

1. User requests logout
2. Application calls passport logout
3. Session destroyed locally
4. If SLO enabled: redirect to IdP logout URL
5. IdP logs out user from all services
6. User redirected back to application

## API Endpoints

### Authentication Endpoints

```
GET  /api/create/auth/config           - Get auth configuration (SAML availability)
POST /api/create/auth/auto-login       - Auto-login for staging (when SAML disabled)
GET  /api/create/auth/me               - Get current user profile
GET  /api/create/auth/saml/login       - Initiate SAML login
POST /api/create/auth/saml/callback    - Handle SAML callback
GET  /api/create/auth/logout           - Logout (handles both SAML and auto-login)
GET  /api/create/auth/logout/callback  - Handle SAML logout callback
```

### Protected Routes

All routes under `/api/create/*` (except auth routes) require authentication via the `authenticateToken` middleware.

## User Data

### SAML Attributes

passport-ubcshib requests the following attributes from UBC IdP:

- `ubcEduCwlPuid` - UBC CWL ID (required)
- `mail` - Email address
- `eduPersonAffiliation` - User role(s) (student, faculty, staff, etc.)
- `displayName` - Full display name
- `givenName` - First name
- `sn` - Last name (surname)

### User Schema

```javascript
{
  cwlId: String,           // UBC CWL ID (unique identifier)
  password: String,        // "saml-authenticated" placeholder
  lastLogin: Date,         // Last login timestamp
  stats: {
    coursesCreated: Number,
    quizzesGenerated: Number,
    questionsCreated: Number,
    totalUsageTime: Number,
    lastActivity: Date
  },
  createdAt: Date,
  updatedAt: Date
}
```

## Local Development Setup

### Prerequisites

1. Docker (for docker-simple-saml)
2. MongoDB running locally
3. Node.js 20+

### Steps

1. Start docker-simple-saml:
```bash
cd /path/to/docker-simple-saml
docker-compose up -d
```

2. Configure local environment:
```bash
cp .env .env.local
# Edit .env.local with LOCAL settings
```

3. Start the application:
```bash
npm run dev
```

4. Test authentication:
   - Visit: http://localhost:8051
   - Click login → redirected to http://localhost:8080
   - Use test credentials from docker-simple-saml

## Staging Deployment

### Prerequisites

1. Register application with UBC IAM team:
   - Provide Service Provider metadata
   - Receive Entity ID confirmation
   - Get IdP certificate

2. Generate SP private key:
```bash
openssl req -newkey rsa:2048 -nodes -keyout sp-key.pem -x509 -days 3650 -out sp-cert.pem
```

3. Place certificates in secure location:
```bash
/etc/create-staging/saml/
├── sp-key.pem       # Your private key (restricted permissions)
└── idp-cert.pem     # UBC IdP public certificate
```

4. Set file permissions:
```bash
chmod 600 /etc/create-staging/saml/sp-key.pem
chmod 644 /etc/create-staging/saml/idp-cert.pem
```

### Deployment Steps

1. Copy `.env.staging` to server
2. Update environment-specific values
3. Build and deploy application
4. Test authentication flow
5. Verify user creation in MongoDB

## Troubleshooting

### Common Issues

#### 1. "Failed to load SAML certificate"
- Check `SAML_CERT_PATH` points to correct file
- Verify file permissions (app must read it)
- Ensure file is in PEM format

#### 2. "No CWL ID found in SAML profile"
- Verify UBC IAM released `ubcEduCwlPuid` attribute
- Check attribute configuration in passport-ubcshib
- Review SAML response in logs

#### 3. SAML validation fails
- Verify SP private key matches registered public key with UBC IAM
- Check issuer/entityID matches exactly
- Ensure callback URL matches registered URL
- Verify server clocks are synchronized (NTP)

#### 4. Session not persisting
- Check `SESSION_SECRET` is set
- Verify session middleware configured correctly
- Ensure cookies are being set (check browser dev tools)
- In production: verify `trust proxy` setting for nginx

### Debugging

Enable detailed logging:
```javascript
console.log('SAML Profile received:', JSON.stringify(profile, null, 2));
```

Check passport-ubcshib configuration:
```javascript
console.log('Strategy options:', samlStrategy._samlOptions);
```

## Security Considerations

1. **Private Keys**
   - Store in secure location outside web root
   - Restrict file permissions (600)
   - Never commit to version control
   - Rotate periodically

2. **Certificates**
   - Validate IdP certificate during SAML response validation
   - Update when IdP certificates are rotated
   - Store securely but readable by application

3. **Session Security**
   - Use strong `SESSION_SECRET`
   - Enable `secure` cookies in production (HTTPS only)
   - Set appropriate `maxAge` for sessions
   - Implement CSRF protection

4. **Environment Variables**
   - Never commit `.env` files
   - Use environment-specific configuration
   - Validate all configuration on startup

## Production Checklist

- [ ] SP private key generated and secured
- [ ] Application registered with UBC IAM
- [ ] IdP certificate obtained
- [ ] Callback URLs registered
- [ ] Entity ID confirmed
- [ ] Attributes released by IdP
- [ ] Test user authentication
- [ ] Test user logout
- [ ] Test session persistence
- [ ] Verify MongoDB user creation
- [ ] Monitor application logs
- [ ] Set up error alerting

## References

- [passport-ubcshib Documentation](../passport-ubcshib/README.md)
- [UBC Shibboleth Documentation](https://id.ubc.ca)
- [SAML 2.0 Specification](https://en.wikipedia.org/wiki/SAML_2.0)
- [Passport.js Documentation](http://www.passportjs.org/)

## Support

For issues with:
- **passport-ubcshib**: Contact UBC IAM team
- **TLEF-CREATE authentication**: Contact TLEF development team
- **UBC Shibboleth IdP**: Contact UBC IT Services
